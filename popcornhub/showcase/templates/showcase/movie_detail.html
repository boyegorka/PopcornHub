{% extends 'base.html' %}
{% load static %}
{% load movie_filters %}

{% block content %}
<div class="page-heading">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 offset-lg-2">
                <div class="heading-content">
                    <h2 style="color: #2a2a2a;">{{ movie.title }}</h2>
                    <div class="rating-info" style="color: #2a2a2a;">
                        {{ movie.average_rating|rating_stars_10|safe }}
                        <span style="margin-left: 10px;">{{ movie.average_rating|floatformat:1 }}/10</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="photos-page" style="padding: 60px 0;">
    <div class="container">
        <div class="row">
            <div class="col-lg-4">
                <div class="movie-poster" style="margin-bottom: 30px;">
                    {% if movie.poster %}
                        <img src="{{ movie.poster.url }}" alt="{{ movie.title }}" class="img-fluid" style="border-radius: 15px;">
                    {% endif %}
                </div>
                <div class="movie-actions">
                    {% if user.is_authenticated %}
                        <form method="post" action="{% url 'showcase:rate-movie' movie.id %}" class="rating-form" style="margin-bottom: 20px;">
                            {% csrf_token %}
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="color: #2a2a2a; display: block; margin-bottom: 10px;">Ваша оценка:</label>
                                <select name="rating" class="form-control" style="margin-bottom: 15px;">
                                    <option value="1">1/10</option>
                                    <option value="2">2/10</option>
                                    <option value="3">3/10</option>
                                    <option value="4">4/10</option>
                                    <option value="5">5/10</option>
                                    <option value="6">6/10</option>
                                    <option value="7">7/10</option>
                                    <option value="8">8/10</option>
                                    <option value="9">9/10</option>
                                    <option value="10">10/10</option>
                                </select>
                            </div>
                            <button type="submit" class="main-button" style="width: 100%;">Оценить</button>
                        </form>
                        <form method="post" action="{% url 'showcase:add-to-favorite' movie.id %}" style="margin-bottom: 20px;">
                            {% csrf_token %}
                            <button type="submit" class="main-button" style="width: 100%;">
                                {% if is_favorite %}
                                    Убрать из избранного
                                {% else %}
                                    Добавить в избранное
                                {% endif %}
                            </button>
                        </form>
                    {% else %}
                        <p style="color: #2a2a2a;">Войдите, чтобы оценить фильм и добавить в избранное</p>
                    {% endif %}
                </div>
            </div>
            <div class="col-lg-8">
                <div class="movie-info" style="background: #fff; padding: 30px; border-radius: 15px;">
                    <div class="info-item" style="margin-bottom: 40px;">
                        <h4 style="color: #2a2a2a; margin-bottom: 20px;">О фильме</h4>
                        <p style="color: #2a2a2a; line-height: 1.7;">{{ movie.description }}</p>
                    </div>
                    <div class="info-item" style="margin-bottom: 40px;">
                        <h4 style="color: #2a2a2a; margin-bottom: 20px;">Детали</h4>
                        <ul style="color: #2a2a2a; list-style: none; padding: 0;">
                            <li style="margin-bottom: 15px;">Дата выхода: {{ movie.release_date }}</li>
                            <li style="margin-bottom: 15px;">Длительность: {{ movie.duration|duration_format }}</li>
                            <li style="margin-bottom: 15px;">Статус: {{ movie.get_status_display }}</li>
                            <li style="margin-bottom: 15px;">Жанры: 
                                {% for genre in movie.genres.all %}
                                    {{ genre.name }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </li>
                        </ul>
                    </div>
                    <div class="info-item" style="margin-bottom: 40px;">
                        <h4 style="color: #2a2a2a; margin-bottom: 20px;">Актеры</h4>
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="actors-section mt-4">
                                    <div class="row">
                                        {% for movie_actor in movie.movieactor_set.all|dictsort:"is_main_role"|dictsortreversed:"is_main_role" %}
                                            <div class="col-md-4 mb-3">
                                                <div class="actor-card {% if movie_actor.is_main_role %}main-role{% endif %}">
                                                    <div class="card">
                                                        {% if movie_actor.actor.photo %}
                                                            <img src="{{ movie_actor.actor.photo.url }}" 
                                                                 class="card-img-top actor-photo" 
                                                                 alt="{{ movie_actor.actor.name }}">
                                                        {% endif %}
                                                        <div class="card-body">
                                                            <h5 class="card-title">{{ movie_actor.actor.name }}</h5>
                                                            <p class="card-text">
                                                                {% if movie_actor.is_main_role %}
                                                                    <span class="badge bg-primary">Главная роль</span>
                                                                {% endif %}
                                                                {% if movie_actor.role %}
                                                                    <span class="role-name">{{ movie_actor.role }}</span>
                                                                {% endif %}
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% empty %}
                                            <div class="col-12">
                                                <p>Информация об актёрах пока не добавлена.</p>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if movie.trailer_video %}
                        <div class="info-item">
                            <h4 style="color: #2a2a2a; margin-bottom: 20px;">Трейлер</h4>
                            <video controls class="w-100" style="border-radius: 10px;">
                                <source src="{{ movie.trailer_video.url }}" type="video/mp4">
                                Ваш браузер не поддерживает видео.
                            </video>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Упрощенная секция с расписанием -->
<div class="showtimes-section mt-5">
    <h4 class="mb-4">Расписание сеансов</h4>
    {% regroup movie.showtime_set.all|dictsort:"start_time"|dictsortreversed:"cinema" by start_time|date:"d.m.Y" as showtime_list %}
    
    {% if showtime_list %}
        {% for date in showtime_list %}
            <div class="date-group mb-4">
                <h5 class="date-header">{{ date.grouper }}</h5>
                <div class="row">
                    {% for showtime in date.list %}
                        <div class="col-md-4 mb-3">
                            <div class="showtime-card">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="cinema-name">{{ showtime.cinema.name }}</h6>
                                        <div class="showtime-info">
                                            <div class="time">{{ showtime.start_time|time:"H:i" }}</div>
                                            <div class="price">{{ showtime.ticket_price }} ₽</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info">
            На данный момент нет запланированных сеансов.
        </div>
    {% endif %}
</div>

{% if user.is_staff %}
    <div class="admin-actions mt-4">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">Панель администратора</h5>
            </div>
            <div class="card-body">
                <div class="d-flex gap-2">
                    <a href="{% url 'admin:showcase_movie_change' movie.id %}" 
                       class="btn btn-primary">
                        <i class="fas fa-edit"></i> Редактировать
                    </a>
                    
                    <!-- Кнопка для вызова модального окна -->
                    <button type="button" 
                            class="btn btn-danger" 
                            data-bs-toggle="modal" 
                            data-bs-target="#deleteMovieModal">
                        <i class="fas fa-trash"></i> Удалить фильм
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения удаления -->
    <div class="modal fade" id="deleteMovieModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Подтверждение удаления</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Вы действительно хотите удалить фильм "{{ movie.title }}"?</p>
                    <p class="text-danger"><strong>Внимание:</strong> Это действие нельзя отменить!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <form method="post" action="{% url 'showcase:movie-delete' movie.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">
                            Подтвердить удаление
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<style>
.page-heading {
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    padding: 100px 0;
    position: relative;
    margin-bottom: 30px;
}

{% if movie.poster %}
.page-heading {
    background-image: url('{{ movie.poster.url }}');
}

.page-heading::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.85);
}
{% endif %}

.heading-content {
    position: relative;
    z-index: 1;
    text-align: center;
}

.form-control {
    background-color: #fff;
    border: 1px solid #ced4da;
    border-radius: 5px;
    padding: 10px;
}

.info-item ul li {
    position: relative;
    padding-left: 0;
}

.actor-card {
    transition: transform 0.2s;
}

.actor-card:hover {
    transform: translateY(-5px);
}

.actor-card.main-role .card {
    border: 2px solid #007bff;
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2);
}

.actor-card.main-role .card-body {
    background-color: #f8f9ff;
}

.actor-photo {
    height: 250px;
    object-fit: cover;
}

.badge {
    font-size: 0.8rem;
    padding: 0.4em 0.8em;
    margin-right: 0.5rem;
}

.role-name {
    color: #6c757d;
    font-style: italic;
}

.main-role .role-name {
    color: #0056b3;
    font-weight: 500;
}

/* Обновленные стили для секции расписания */
.showtimes-section {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
}

.date-header {
    color: #0056b3;
    padding-bottom: 10px;
    border-bottom: 2px solid #e9ecef;
    margin-bottom: 20px;
}

.showtime-card .card {
    transition: transform 0.2s;
}

.showtime-card .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.cinema-name {
    color: #2c3e50;
    margin-bottom: 10px;
    font-weight: 600;
}

.showtime-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.time, .price {
    color: #6c757d;
    font-size: 1.1em;
}
</style>
{% endblock %} 